<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Your Councillors</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <header>
        <img src="./images/divest-for-palestine.jpeg" alt="Banner">
    </header>
    <main>
        <h1>Tell your ward councillors to Divest Now!</h1>
        <div class="explanation">
            <p>Use this tool to find and contact your local councillors. Simply
            enter your postcode and name, and this tool will provide links that 
            will open a ready to send email using the email client configured 
            on your machine.</p>
        </div>
        <form id="custom-form">
            <input type="text" id="firstName" placeholder="Enter your first name" required>
            <input type="text" id="lastName" placeholder="Enter your last name" required>
            <input type="text" id="query" placeholder="Enter postcode" required>
            <button type="submit">Submit</button>
        </form>
        <div class="explanation">
            <p>Please forward any responses from your councillor to info@lewishampsc.org</p>
        </div>
    </main>

    <!-- Modal structure -->
    <div id="resultModal">
        <div id="modalContent">
            <div id="loading" style="display: none;">
                <div class="spinner"></div>
                <div>Loading, please wait...</div>
            </div>
            <div id="result"></div>
            <button id="closeModal">Close</button>
        </div>
    </div>

    <script type="text/javascript">
        var councillorsNameToken = '{councillorName}';
        var wardToken = '{ward}';
        var signeeToken = '{signee}';
        const defaultEmailBodyTemplate = `Dear%20%7BcouncillorName%7D%2C%0A%0AI%20am%20writing%20as%20a%20resident%20of%20your%20ward%2C%20aware%20that%20on%20Thursday%2016th%20July%20Lewisham%20Council%20will%20be%20debating%20divestment%20of%20the%20pension%20scheme%20from%20companies%20complicit%20in%20Israel%27s%20violations%20of%20international%20law%20%28as%20well%20as%20the%20end%20of%20the%20council%27s%20business%20relationship%20with%20Barclay%27s%20bank%29.%20I%20am%20asking%20you%20to%20take%20action%20in%20the%20debate%20to%20support%20this%20cause.%0A%0AI%20am%20sure%20that%20you%20have%20previously%20been%20contacted%20by%20residents%20and%20pension%20holders%20who%20are%20disgusted%20and%20disturbed%20that%20Lewisham%20Council%20continue%20to%20oversee%20a%20pension%20fund%20that%20holds%20investments%20in%20companies%20profiting%20from%20Israel%27s%20genocide%20and%20apartheid%20-%20including%20arms%20companies%20and%20companies%20that%20the%20UN%20has%20identified%20as%20profiting%20from%20illegal%20occupation.%0A%0AI%20am%20aware%20of%20and%20grateful%20for%20the%20ongoing%20work%20of%20the%20Pension%20Investment%20Committee%20in%20exploring%20this%20issue%20and%20hopefully%20-%20eventually%20-%20addressing%20it.%20However%2C%20in%20the%20meantime%20Lewisham%20Council%20has%20the%20historic%20opportunity%20to%20make%20clear%20the%20council%27s%20support%20for%20divestment.%20Alongside%20the%20work%20of%20pension%20committees%20in%20some%20local%20authorities%2C%20whole-council%20motions%20for%20divestment%20have%20been%20passed%20in%20Manchester%2C%20Peterborough%2C%20Oxford%2C%20Sandwell%20%28all%20Labour-led%20councils%29%2C%20Tower%20Hamlets%2C%20Bristol%2C%20North%20Somerset%2C%20and%20Dudley%20%28with%20more%20to%20come%29.%20Belfast%20and%20Labour-led%20Islington%20have%20signalled%20their%20intent%20to%20move%20away%20from%20Barclay%27s%20bank%20when%20contracts%20end.%20As%20a%20borough%20which%20is%20rightly%20proud%20of%20its%20anti-racist%20and%20progressive%20history%2C%20Lewisham%20residents%20look%20forward%20with%20pride%20to%20seeing%20our%20borough%20following%20the%20example%20of%20these%20other%20councils.%20Lewisham%20Council%27s%20proud%20history%20includes%20its%20action%20against%20the%20apartheid%20regime%20in%20South%20Africa.%20Lewisham%20was%20one%20of%20the%20first%20councils%20to%20permanently%20boycott%20South%20African%20products%20in%20the%201960s%2C%20as%20well%20as%20later%20moving%20their%20accounts%20from%20Barclay%27s%20bank%20because%20of%20their%20complicity%20in%20the%20apartheid%20regime.%20Please%20reflect%20on%20this%20as%20you%20consider%20your%20stewardship%20of%20Lewisham%27s%20legacy.%0A%0AThis%20debate%20has%20been%20triggered%20by%20a%20local%20petition%2C%20one%20of%20the%20first%20in%20recent%20memory%20to%20reach%20the%20required%20threshold%20for%20debate.%20No%20doubt%20you%E2%80%99re%20aware%20of%20the%20strength%20of%20feeling%20in%20Lewisham%20on%20this%20issue.%20The%20divestment%20campaign%20has%20been%20canvassing%20on%20this%20single%20issue%2C%20and%20it%E2%80%99s%20clear%20the%20majority%20of%20constituents%20are%20in%20favour%20of%20divestment.%0A%0AThe%20Pension%20Investment%20Committee%20has%20committed%20to%20consulting%20with%20pension%20members%20on%20their%20preferences%2C%20in%20line%20with%20the%20PIC%27s%20fiduciary%20duty.%20Whilst%20not%20pre-empting%20this%20process%20locally%2C%20there%20can%20be%20no%20serious%20suggestion%20that%20divestment%20is%20not%20supported.%20You%20may%20have%20seen%20the%20results%20from%20a%20recent%2C%20similar%20exercise%20in%20Hackney%2C%20where%2082%25%20of%20council%20pension%20holders%20felt%20that%20it%20was%20important%20to%20consider%20%27things%20like%20climate%20change%2C%20human%20rights%20and%20equality%20...%20when%20the%20Pension%20Fund%20thinks%20about%20how%20it%20invests%20its%20money%27%20-%20with%20%27human%20rights%2C%20including%20conflict%27%20ranked%20as%20the%20most%20important%20ESG%20issue%20%28above%20climate%20change%29%20by%20the%20largest%20group%20of%20pension%20holders.%0A%0ARecent%20national%20polling%20has%20also%20shown%20that%20voters%20back%20local%20government%20pension%20scheme%20divestment%20from%20companies%20complicit%20in%20Israel%E2%80%99s%20violations%20of%20international%20law%20by%20a%20ratio%20of%203%20to%201%20-%20including%20voters%20who%20backed%20Labour%20at%20the%202024%20election.%20All%20of%20this%20information%20is%20available%20publicly%20and%20I%20would%20encourage%20you%20to%20seek%20it%20out%20as%20well%20as%20to%20speak%20to%20more%20constituents%20about%20the%20issue.%20Source%3A%20https%3A%2F%2Fwww.thecanary.co%2Fuk%2Fnews%2F2025%2F06%2F05%2Farms-embargo-israel-uk-poll%2F%26sa%3DD%26source%3Ddocs%26ust%3D1751708960270507%26usg%3DAOvVaw2KEHQxPn5vl-t48Ga5_Wcn%0A%0AI%20am%20sure%20that%20you%20are%20also%20aware%20that%20Labour%20party%20candidates%20have%20recently%20lost%20by-elections%20in%20our%20neighbouring%20boroughs%20of%20Lambeth%20%28overturning%20a%20700%20seat%20majority%29%20and%20Greenwich%20%28overturning%20a%201000%20seat%20majority%29%20-%20in%20no%20small%20part%20due%20to%20the%20party%27s%20stance%20on%20the%20genocide.%20Whilst%20the%20Lewisham%20divestment%20campaign%20are%20not%20affiliated%20with%20any%20individual%20political%20parties%2C%20they%20will%20of%20course%20be%20taking%20note%20of%20any%20councillors%20who%20do%20not%20support%20or%20indeed%20seek%20to%20frustrate%20the%20democratic%20desire%20for%20Lewisham%20to%20divest%20from%20companies%20complicit%20in%20genocide.%20And%20in%20any%20such%20cases%2C%20where%20councillors%20are%20putting%20their%20individual%20ideologies%20or%20private%20interests%20ahead%20of%20the%20desires%20of%20their%20constituents%2C%20the%20campaign%20will%20mobilise%20their%20supporters%20for%20the%20council%20elections%20in%202026%3B%20it%20is%20only%20proper%20that%20all%20voters%20are%20made%20aware%20how%20individual%20councillors%20choose%20to%20act%2C%20and%20that%20voters%20be%20given%20the%20chance%20to%20democratically%20remove%20such%20obstacles.%0A%0AHowever%2C%20I%20trust%20that%20you%20will%20show%20your%20support%20for%20any%20motions%20in%20the%20debate%20that%20help%20progress%20divestment%2C%20and%20if%20you%20are%20given%20the%20opportunity%20to%20speak%20in%20the%20debate%20you%20will%20be%20outspoken%20in%20your%20support%20of%20divestment%20and%20moving%20banking%20services%20away%20from%20Barclays.%0A%0AYours%20sincerely%2C%0A%7Bsignee%7D`;
        const emailBodyTemplateOverride = {
        }
        function getFullName(firstname, lastname) {
            return `${firstname} ${lastname}`;
        }
        function getEmailBody(councillor, ward, signee) {
            var emailBodyTemplate = emailBodyTemplateOverride[councillor.email.toLowerCase()] || defaultEmailBodyTemplate;
            
            return emailBodyTemplate.replace(encodeURIComponent(councillorsNameToken), encodeURIComponent(councillor.name))
                .replace(encodeURIComponent(wardToken), encodeURIComponent(ward))
                .replace(encodeURIComponent(signeeToken),  encodeURIComponent(signee));
        }

        function generateMailingListUrl(firstname, lastname, ward) {
           return `https://tinyurl.us15.list-manage.com/subscribe?u=9818ca931e429fb5e27237ebe&id=9739e46cf0&FNAME=${encodeURIComponent(firstname)}&LNAME=${encodeURIComponent(lastname)}&WARD=${encodeURIComponent(ward)}`;
        }

        function generateLinks(councillors, ward, firstname, lastname) {
            const fullname = getFullName(firstname, lastname);
            let html = '';
        
            // First show the regular links with full mailto
            html += '<p>We found ' + councillors.length + ' councillors for the ward of ' + ward +
                    '.</p><p>Please click on each councillor below to send them an email:</p>';
        
            // Simple list of email links
            html += '<div class="councillor-links">';
            councillors.forEach(function(councillor) {
                var emailBody = getEmailBody(councillor, ward, fullname);
                html += `<a class="councillor-link" target="_blank" 
                        href="mailto:${councillor.email}?bcc=info@lewishampsc.org&subject=Council debate on divestment for Palestine&body=${emailBody}">
                        Email ${councillor.name}
                    </a>`;
            });
            html += `<p>Click <a target="_blank" href="${generateMailingListUrl(firstname,lastname,ward)}" id="mailingListLink">here</a> to join our mailing list and stay updated on our campaign.</p>`;
            html += '</div>';
        
            // Fallback section remains the same
            html += `<div class="fallback-section">
                <h2>Links not opening correctly?</h2>
                <p>Some email clients have limitations with long email bodies. If the links above don't work, follow these steps:</p>
        
                <div class="fallback-instructions">
                    <ol>
                        <li><strong>Step 1:</strong> Click a councillor's name below</li>
                        <li><strong>Step 2:</strong> Click "Copy email text" to copy the full message</li>
                        <li><strong>Step 3:</strong> Click "Open email" to launch your email program</li>
                        <li><strong>Step 4:</strong> Paste the copied text into the email body and send</li>
                    </ol>
                </div>
        
                <div class="fallback-councillors">`;
        
            councillors.forEach(function(councillor) {
                var emailBody = getEmailBody(councillor, ward, name);
                var decodedEmailBody = decodeURIComponent(emailBody);
        
                html += `<div class="fallback-councillor">
                    <div class="councillor-name" data-councillor-id="${councillor.email}">
                        ${councillor.name} <span class="toggle-icon">▼</span>
                    </div>
                    <div class="councillor-actions" id="actions-${councillor.email.replace(/[@.]/g, '-')}" style="display:none;">
                        <button class="copy-email-btn" data-email="${escapeHtml(decodedEmailBody)}">
                            Copy email text
                        </button>
                        <a class="email-link" target="_blank"
                           href="mailto:${councillor.email}?bcc=info@lewishampsc.org&subject=Council debate on divestment for Palestine">
                           Open email
                        </a>
                    </div>
                </div>`;
            });
        
            html += '</div></div>';
        
            return html;
        }
        
        // Helper function to escape HTML for data attributes
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        jQuery(document).ready(function($) {
        $('#custom-form').on('submit', function(event) {
            event.preventDefault();

            const firstname = $('#firstName').val().trim();
            const lastname = $('#lastName').val().trim();
            var query = $('#query').val();
            var url = 'https://script.google.com/macros/s/AKfycbzN7FhBAz0U4Kl3PnpFI79_NsnM4cfLHZsDIAz2_zcWBsXs1sPkDUF0Z6OTA8zA4Tkb/exec?postcode=' + encodeURIComponent(query);

            // Show the modal and the loading spinner
            $('#result').html('');  // Clear previous result
            $('#loading').show();
            $('#resultModal').css('display', 'flex');  // Show the modal

            $.get(url, function(response) {
                var ward = response.ward;
                var councillors = response.councillors;
                var resultHtml = '';
            
                if (!ward) {
                    resultHtml = '<p>We could not find the postcode in our database.</p><p>This tool only works with postcodes in the London Borough of Lewisham, please ensure you entered a valid Lewisham postcode.</p>';
                } else {
                    resultHtml = generateLinks(councillors, ward, firstname, lastname);
                }
            
                // Hide the loading spinner and show the result
                $('#loading').hide();
                $('#result').html(resultHtml);
            });
        });
        
        // Copy email to clipboard functionality
        $(document).on('click', '.copy-email-btn', function() {
            const emailText = $(this).data('email');
            const councillorName = $(this).data('name');
            const $instructions = $(this).siblings('.copy-instructions');
            
            navigator.clipboard.writeText(emailText)
                .then(() => {
                    // Show instructions
                    $instructions.slideDown();
                    // Change button text temporarily
                    const $btn = $(this);
                    const originalText = $btn.text();
                    $btn.text('Copied! ✓');
                    setTimeout(() => $btn.text(originalText), 2000);
                })
                .catch(err => {
                    alert('Could not copy email text: ' + err);
                });
        });

        $(document).on('click', '.councillor-name', function() {
            const councillorId = $(this).data('councillor-id');
            const actionsId = '#actions-' + councillorId.replace(/[@.]/g, '-');
            $(actionsId).slideToggle(200);
            $(this).toggleClass('toggle-active');
        });
        
        // Close modal button
        $('#closeModal').on('click', function() {
            $('#resultModal').css('display', 'none');  // Hide the modal
        });
    });
    </script>
</body>
</html>
